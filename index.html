<!DOCTYPE html>
<html>
  <head>
    <title>Account Demo</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible"
          content="IE=edge">
    <meta name="viewport"
          content="width=device-width,
                   initial-scale=1.0,
                   maximum-scale=1.0,
                   user-scalable=no" />
    <meta name="HandheldFriendly"
          content="true" />
    <script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es7-shim/6.0.0/es7-shim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.js"></script>
  </head>
  <body
    id="react-app" 
    style="
      margin: 0;
      padding: 0;
      background: #44537A;
      font-family: 'Helvetica Neue', Helvetica, sans-serif;
      font-size: 0.8rem;
    "
  >
    <script type="text/babel">
      // ----------------------------------------------------------------------
      // Components

      const Button = (props) => (
        <button
          style={Object.assign({
            height: "32px",
            borderWidth: "0",
            borderStyle: "solid",
            borderRadius: "10px",
            fontSize: "0.9em",
          }, props.style)}
          onClick={props.onClick}
        >
          {props.children}
        </button>
      );

      const DropdownItem = (props) => (
        <p
          onClick={props.onClick}
          onKeyPress={(e) => (e.key === "Enter" || e.key === " ") && props.onClick()}
          style={{
            margin: "0",
            padding: "6px 3px",
          }}
          tabIndex="0"
        >
          {props.children}
        </p>
      );

      const Dropdown = (props) => (
        props.enabled ?
          <div style={{
            marginTop: "2px",
            borderTop: "solid 1px #999",
            width: "500px"
          }}>
            {props.list.map((e) =>
              <DropdownItem onClick={() => props.onClick(e.id)}>
                {e.name}
              </DropdownItem>
            )}
          </div>
        :
          null
      );

      class AccountInput extends React.Component {
        constructor(props) {
          super(props);
          this.state = { value: "" };
          this.onChange = this.onChange.bind(this);
        }

        onChange(e) {
          const value = e.target.value;
          this.setState({ value });
          this.props.onValueChange(value);
        }

        render() {
          return (
            <input
              type="text"
              value={this.state.value}
              onChange={this.onChange}
              placeholder="Enter account name"
              style={{
                height: "36px",
                padding: "0 6px",
                border: "none",
              }}
            />
          );
        }
      }

      const AccountView = (props) => (
        <div style={{
            display: "inline-block",
            padding: "10px 30px 10px 10px",
            background: "#FFF",
            borderRadius: "6px",
        }}>
          <h2 style={{ margin: "0" }}>
            Account Details for {props.nameFirst} {props.nameLast}
          </h2>
          <p>ID: {props.id}</p>
          <p>First Name: {props.nameFirst}</p>
          <p>Last Name: {props.nameLast}</p>
          <p>Gender: {props.gender}</p>
          <p>Email: {props.email}</p>
          <p>IP: {props.ip}</p>
          <div style={{ display: "flex", justifyContent: "space-between" }}>
            <Button
              style={{
                marginTop: "8px",
                color: "#FFF",
                backgroundColor: "red",
              }}
              onClick={() => {
                const choice = window.confirm("Are you sure you want to delete this account?");
                (choice && props.onDelete(props.id));
              }}
            >
              DELETE ACCOUNT
            </Button>
            <Button
              style={{
                marginTop: "8px",
                color: "#FFF",
                backgroundColor: "#777",
              }}
              onClick={props.goBack}
            >
              Go Back
            </Button>
          </div>
        </div>
      );

      const Main = (props) => {
        // State processing and data transformation
        const matchingNames = props.filterAccounts(props.allAccounts, props.searchString);
        const showDropdown = !!props.searchString;

        // Root component
        return (
          <div style={{ padding: "10px" }}>
            {props.currentAccount ?
              <AccountView
                {...props.currentAccount}
                onDelete={props.deleteAccount}
                goBack={props.goBack}
              />
            :
              <div style={{
                display: "flex",
                flexDirection: "column",
                maxWidth: "500px",
                background: "#FFF",
              }}>
                <AccountInput onValueChange={props.setSearchString} />
                <Dropdown
                  enabled={showDropdown}
                  list={matchingNames}
                  onClick={props.getAccountById}
                />
              </div>
            }
          </div>
        );
      };


      // ----------------------------------------------------------------------
      // HTTP requests and responses

      const makeRequest = (method, url, handler) => {
        const httpRequest = new XMLHttpRequest();
        httpRequest.onreadystatechange = () =>
          httpRequest.readyState === 4 && handler(httpRequest);
        httpRequest.open(method, url);
        httpRequest.send();
      };

      // Request handlers
      const getAccountsHandler = (request) => {
        if (request.status === 200) {
          update("allAccounts", JSON.parse(request.responseText));
        } else {
          console.log("Unexpected Error");
        }
      };

      const getAccountByIdHandler = (request) => {
        if (request.status === 200) {
          update("searchString", "");
          update("currentAccount", JSON.parse(request.responseText));
        } else if (request.status === 404) {
          console.log("Account with the specified id is not found");
        } else {
          console.log("Unexpected Error");
        }
      };

      const deleteAccountHandler = (request) => {
        if (request.status === 204) {
          console.log("Account deleted successfully");
          getAccounts();
        } else {
          console.log("Unexpected Error");
        }
      };

      const URL = "https://dev.presscentric.com/test/accounts";
      const getAccounts = () => makeRequest("GET", URL, getAccountsHandler);
      const getAccountById = (id) => makeRequest("GET", `${URL}/${id}`, getAccountByIdHandler);
      const deleteAccount = (id) => makeRequest("DELETE", `${URL}/${id}`, deleteAccountHandler);


      // ----------------------------------------------------------------------
      // State and state handling
      const update = (path, data) => {
        appState[path] = data;
        renderMain();
      };

      // match account name to search string (case insensitive)
      const filterAccounts = (accounts, searchString) => (
        accounts.filter((e) => e.name.toLowerCase().includes(searchString.toLowerCase()))
      );

      // State
      const appState = {
        // state data
        allAccounts: [],
        currentAccount: undefined,
        searchString: "",

        // callback functions
        setSearchString: (data) => update("searchString", data),
        filterAccounts,
        getAccountById,
        deleteAccount,
        goBack: () => update("currentAccount", undefined),
      };


      // ----------------------------------------------------------------------
      // Render the view
      const renderMain = () => ReactDOM.render(
        Main(appState),
        document.getElementById("react-app")
      );

      // Inital request and render:
      getAccounts();
      renderMain();

    </script>
  </body>
</html>
